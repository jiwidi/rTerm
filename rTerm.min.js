rTerm=function(b){return this.file=b.file,this.divid=b.div||'rterm',this.username=b.username||'user',this.hostname=b.hostname||'hostname',this.fsstart=b.fsstart||'/home/'+this.username,this.height=b.height||400,this.maxStrings=b.maxStrings||15,this.saveStrings=b.saveStrings||!1,this.loggerAppPort=b.loggerAppPort||9091,this.chartime=250,this.cdir=this.fsstart,this.uhsername=this.username+'@'+this.hostname,this.data={},this.clicked=!1,this.init=function(){$.getJSON(this.file,function(c){if(this.data=c,window.onblur=function(){window.blurred=!0},window.onfocus=function(){window.blurred=!1},'undefined'!==this.data.upstart){var d=this.callUpstart();setTimeout(function(){$(document).keydown(this.keyCallback)},d)}else $(document).keydown(this.keyCallback)}.bind(this)),$('#'+this.divid).html('<div id="term"> <span id="termcli">'+this.termPrev+'</span><span class="cursor">&#9608</span></div>')},this.termPrev='<b>'+this.uhsername+'</b>:~$  ',this.oldInput='',this.input='',this.nStrings=0,this.callUpstart=function(){var c=0;for(cid in this.upcid=0,this.upstartInterrupted=!1,this.data.upstart)0<cid&&(c+=(this.data.upstart[cid-1].length+1)*this.chartime),setTimeout(function(){return window.blurred&&!this.upstartInterrupted?(this.callUpstartImmediately(this.data.upstart.slice(this.upcid)),void(this.upstartInterrupted=!0)):void(this.upstartInterrupted||this.enterCommand(this.data.upstart[this.upcid]),this.upcid++)},c);return c+=(this.data.upstart[this.data.upstart.length-1].length+1)*this.chartime,c},this.callUpstartImmediately=function(c){for(command of c)this.enterCommandImmediately(command)},this.enterCommand=function(c){for(lid in this.currlid=0,this.interruptCommand=!1,c)setTimeout(function(){return window.blurred&&!this.interruptCommand?(this.enterCommandImmediately(c.slice(this.currlid)),void(this.interruptCommand=!0)):void(this.interruptCommand||this.addCallback(c[this.currlid]),this.currlid++)},this.chartime*lid);setTimeout(function(){this.interruptCommand||this.enterCallback()},this.chartime*c.length)},this.enterCommandImmediately=function(c){for(l of c)this.addCallback(l);this.enterCallback()},this.updateTerm=function(){for($('#termcli').html(this.oldInput+this.termPrev+this.input);$('#term').height()>this.height;)this.delFristString(),$('#termcli').html(this.oldInput+this.termPrev+this.input)},this.delFristString=function(){var c=this.oldInput.indexOf('<br>');this.oldInput=this.oldInput.slice(c+4,-4)+'<br>',this.nStrings--},this.keyCallback=function(c){1==c.key.length?this.addCallback(c.key):8==c.which||46==c.which||110==c.which?this.delCallback():13==c.which&&this.enterCallback()}.bind(this),this.addCallback=function(c){this.input+=c,this.updateTerm()}.bind(this),this.delCallback=function(){this.input=this.input.slice(0,-1),this.updateTerm()}.bind(this),this.enterCallback=function(){if(''==this.input)this.emptyCallback();else{this.saveStrings&&this.sendString(this.input);var c=this.input.split(' ');c[0]in this.funcMap?this.funcMap[c[0]](c):this.unknownCallback()}}.bind(this),this.emptyCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>',this.nStrings++,this.updateTerm()}.bind(this),this.unknownCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>'+this.input+': command not found<br>',this.input='',this.nStrings+=2,this.updateTerm()}.bind(this),this.sendString=function(c){$.ajax({url:'https://'+window.location.hostname+':'+this.loggerAppPort+'?'+c,dataType:'jsonp'})}.bind(this),this.getByPath=function(c){var d='';d=c.startsWith('/')?c:c.startsWith('~')?this.fsstart+'/'+c.slice(1):this.cdir+'/'+c,d.endsWith('/')&&(d=d.slice(0,-1));var e=d.split('/').slice(1),f=[];for(i in e)if('..'==e[i]){if(0<f.length)f.splice(-1,1);else continue;}else if('.'==e[i])continue;else f.push(e[i]);d='/'+f.join('/');var g=this.data.fs;for(folder of f)g=g[folder];return[g,d]}.bind(this),this.lsCallback=function(c){this.oldInput+=this.termPrev+this.input+'<br>',this.nStrings++;var d=!1,e=!1,f=this.cdir;for(arg of c.slice(1))arg.startsWith('-')?'-a'==arg?d=!0:'-l'==arg&&(e=!0):f=arg.startsWith('/')?arg:f+'/'+arg;var g=this.getByPath(f)[0];if('undefined'==typeof g)this.oldInput+='ls: cannot access \''+f+'\': No such file or directory<br>',this.nStrings++;else for(item in g)(!item.startsWith('.')||d)&&(this.oldInput+='string'==typeof g[item]?g[item].startsWith('_link:')?'<a class="link" href="'+g[item].slice(6)+'" target="_blank">'+item+'</a><br>':item+'<br>':'<font color="#729FCF">'+item+'</font><br>',this.nStrings++);this.input='',this.updateTerm()}.bind(this),this.catCallback=function(c){var d=this.getByPath(c[1])[0];if(''==d||'undefined'==typeof d)this.oldInput+=this.termPrev+this.input+'<br>'+this.input+': No such file or directory<br>';else if(d.startsWith('_call:')){var c=d.slice(6).split(' ');if(c[0]in this.funcMap)return void this.funcMap[c[0]](c);this.oldInput+=this.termPrev+this.input+'<br>'+d+'<br>'}else this.oldInput+=this.termPrev+this.input+'<br>'+d+'<br>';this.input='',this.nStrings+=2,this.updateTerm()}.bind(this),this.cdCallback=function(c){var d='';d=2>c.length||' '==c[1]?'~':c[1];var[e,f]=this.getByPath(d);if('undefined'==typeof e)this.oldInput+=this.termPrev+this.input+'<br>'+this.input+': No such file or directory<br>',this.input='',this.nStrings+=2;else if('string'==typeof e)e.startsWith('_link:')?(this.oldInput+=this.termPrev+this.input+'<br>',this.input='',this.nStrings++,window.open(e.slice(6),'_blank').focus()):(this.oldInput+=this.termPrev+this.input+'<br>'+this.input+': Not a directory<br>',this.input='',this.nStrings+=2);else if('object'==typeof e){this.cdir=f,this.oldInput+=this.termPrev+this.input+'<br>',this.input='',this.nStrings++;var g=this.cdir;g==this.fsstart&&(g='~'),this.termPrev='<b>'+this.uhsername+'</b>:'+g+'$  '}this.updateTerm()}.bind(this),this.pwdCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>'+this.cdir+'<br>',this.input='',this.nStrings+=2,this.updateTerm()}.bind(this),this.whoamiCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>',this.nStrings++;for(item of this.data.whoami)this.oldInput+=item+'<br>',this.nStrings++;this.input='',this.updateTerm()}.bind(this),this.unameCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>'+this.data.uname+'<br>',this.input='',this.nStrings+=2,this.updateTerm()}.bind(this),this.randomCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>'+(Math.random()+'<br>'),this.input='',this.nStrings+=2,this.updateTerm()}.bind(this),this.idkCallback=function(){for(item in this.oldInput+=this.termPrev+this.input+'<br>',this.nStrings++,this.funcMap)this.oldInput+=item+'<br>',this.nStrings++;this.input='',this.updateTerm()}.bind(this),this.exitCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>',this.nStrings++,$(document).unbind('keydown',this.keyCallback),this.input='',this.updateTerm()}.bind(this),this.echoCallback=function(){var c=this.input.slice(5);this.oldInput+=this.termPrev+this.input+'<br>'+c+'<br>',this.nStrings+=2,this.input='',this.updateTerm()}.bind(this),this.hiCallback=function(){this.oldInput+=this.termPrev+this.input+'<br>hiii!<br>',this.nStrings+=2,this.input='',this.updateTerm()}.bind(this),this.funcMap={ls:this.lsCallback,cd:this.cdCallback,cat:this.catCallback,whoami:this.whoamiCallback,uname:this.unameCallback,idk:this.idkCallback,help:this.idkCallback,random:this.randomCallback,pwd:this.pwdCallback,exit:this.exitCallback,echo:this.echoCallback,hi:this.hiCallback},this.init(),this};
